# TCP/IP

# 网络基础知识

# TCP/IP 概览

# 数据链路

## 数据链路层是干啥的

TCP/IP 中其实并未定义数据链路层和物理层，视为透明，不过还是在这里学一下（和网络中其他部分必然有重复啦）。

数据链路层的协议定义了通过**通信媒介**进行互联的设备之间的传输规范。通信媒介包括同轴电缆双绞线等，传输时也会经过交换机（2口的叫网桥）、中继器等设备。数据链路层中，以“帧”为单位传输数据块。

> 在不可靠的物理介质上提供可靠的传输，接收来自物理层的位流形式的数据，并封装成帧，传送到上一层；同样，也将来自上层的数据帧，拆装为位流形式的数据转发到物理层。这一层在物理层提供的比特流的基础上，通过差错控制、流量控制方法，使有差错的物理线路变为无差错的数据链路。提供物理地址寻址功能。交换机工作在这一层。

## 数据链路层相关技术

### MAC 地址

MAC 地址用于识别数据链路中互联的节点，一般被烧录到 ROM 中，任何一个网卡的 MAC 地址都是唯一的。（例外情况，虚拟设备的MAC可以自己设定，其实也可以改MAC地址，只要保证同MAC地址的设备不属于同一个数据链路即可）

| 第 1 位        | 第2位                 | 第3~24位   | 第25~48位    |
| -------------- | --------------------- | ---------- | ------------ |
| 表示 单播/多播 | 表示全局地址/本地地址 | 厂商识别码 | 厂商内识别码 |

### 共享介质型网络
共享介质型网络指的是多个设备共享一个通信介质（比如多台电脑直接连在一根线上），基本是半双工的。为了防止冲突，需要进行介质访问控制，对应两种方式
+ 争用方式
  + CSMA  载波监听多路访问：确认没有其他设备发送数据，然后自己发送数据
  + CSMA-CD (with Collision Detection) ：除了CSMA的限定，还需要一边发送一边监测信道情况（电压），一旦冲突就放弃发送，随机延时一段时间再重新征用介质
+ 令牌传递方式：令牌按序传递，持有令牌才能发送数据

### 非共享介质网络

不同设备不共享介质，每个站点直连交换机，由交换机负责转发数据帧。这种连接在全双工模式下不会有冲突，不需要CSMA/CD的机制，可以高效通信。【Tip：双绞线内，发送和接收的线是分开的，所以可以全双工】

该方式还可以根据交换机的高级特性构建 VLAN 和进行流量控制。

### 根据MAC地址转发

> 设备介绍：交换机。交换机是有多个端口的网桥，根据数据链路层中每个帧的目标MAC地址，决定从哪个接口发送数据（需要参考转发表，其系通信过程中自动学习生成）。【Tip：交换机没有 MAC 地址，从来都不是数据帧的目的地址，只是负责转发。】转发方式分为存储转发（需要先完整接收整个帧，带校验）和直通转发（较快）。
>
> 更多设备介绍：https://mp.weixin.qq.com/s/BJqp72EyEMahxi2XOfSrBQ

### 环路监测技术

环路监测技术。用网桥链接的设备，拓扑结构可能出现环路。最坏的情况下，数据帧会在环路中被持续转发。有两种解决办法：

+ 生成树方法：每隔一段时间交换信息，优先使用某些端口，另一些端口作为备份不使用。
+ 源路由法：用于解决令牌环网络的问题，源路由的用户可以指定他所发送的数据包沿途经过的部分或者全部路由。

### VLAN

> + 图文并茂VLAN详解，让你看一遍就理解VLAN - 51CTO网工运维之家的文章 - 知乎 https://zhuanlan.zhihu.com/p/385949949
> + 网络工程师（17）：用路由器让VLAN之间互通 - 微峰清雨的文章 - 知乎 https://zhuanlan.zhihu.com/p/137368250

![](./tcp-ip/数据链路/VLAN.png)

VLAN 的目的是：将同一个局域网划分成不同的广播域，避免广播风暴。例如我们实验室里，大家通过两个交换机互相连接，且只有其中一个交换机连了一个路由器。

在现在我需要【和宇晨进行通信】，我知道他的 IP 地址，那么为了获取他的 MAC 地址，我发了一个广播消息，于是实验室里所有人都收到了这个消息，这不好。为了避免广播风暴，我们建立了两个 VLAN（暂时只考虑左边的交换机，右边当成不存在），发 ARP 消息的时候，只有宇晨能收到我的消息，鲍鲍和冰冰和我不在一个 VLAN，所以收不到。（通过在数据帧上加 VLAN ID 实现）。

如果我要【和鲍鲍通信】怎么办？用路由器啊。从我的角度来看，我和鲍鲍不在一个局域网中，通过路由器，我把数据帧经由交换机发给路由器，路由器再经由交换机发给鲍鲍。我并不知道我和鲍鲍连在一个交换机上。那怎么用路由器连接两个不同VLAN？一种方法是，每个VLAN都单独连接到路由器的一个端口，不过这太浪费路由器端口了。所以可以将路由器的一个接口划分为几个逻辑接口，每个子接口处理不同VLAN的帧，就可以节省大量的物理接口。交换机通过一个Trunk接口连接路由器，这种方式叫**单臂路由**。但是，如果使用路由器进行 VLAN 间路由的话，随着 VLAN 之间流量的不断增加，很可能导致路由器成为整个网络的瓶颈。所有有了三层交换机，就是“带有路由功能的（二层）交换机”，由于是内部连接，可以确保相当大的带宽。

我们和交换机的连接方式叫做 **访问链接（Access Link）**，指的是“只属于一个VLAN，且仅向该VLAN转发数据帧”的端口。那么问题来了，我要跨交换机和成新宇通信怎么办？两个交换机之间怎么连？用**汇聚链接（Trunk Link）**。汇聚链接指的是能够转发多个不同VLAN的通信的端口。即，一条通道上承载多个 VLAN 的消息，加上 VLAN ID 以示区分。这样就不需要不同 VLAN 专门各用一个端口互联了。

## 以太网

以太网是什么：以太网是一种为实现“局域网”而设计出来的技术标准，或者说，以太网是局域网（在数据链路层）的一种实现方式，它规定了包括物理层的连线、电子信号和介质访问层协议的内容。比如，数据帧是什么？如何使用MAC地址实现设备间的通信？如何获取MAC地址？

### 以太网连接形式

最初：多台终端使用同一根同轴电缆的共享介质型连接方式。现在：终端与交换机中间独立电缆连接。

### 以太网的分类

根据不同通信电缆（同轴电缆、双绞线、光纤等）和不同通信速度，衍生出不同类型。

值得注意的是，计算机内部的数据存储, 1K=2^10,而在数据传输中，是按照时钟频率来算的，1K=1000

### 以太网 帧 格式

#### Ethernet II 帧格式

| 6字节         | 6字节       | 2字节 | 46~1500字节           | 4字节 |
| ------------- | ----------- | ----- | --------------------- | ----- |
| 目标 MAC 地址 | 源 MAC 地址 | 类型  | 数据（TCP/UDP报文等） | FCS   |

+ 【以太网帧头】有 14 个字节，除了目标/源 MAC 地址，还有一个 2 字节的类型用来表示上层协议（ IPV4、IPV6、ARP、RARP等等）。

+ 【数据】46~1500字节的数据
+ 【帧尾】4字节的帧检验序列 FCS(Frame Check Sequence)，用于检查帧是否有损坏，若损坏则丢弃。FCS是用帧除以生成多项式的余数算出来的。

#### IEEE802.3 Ethernet 帧格式

| 6字节    | 6字节  | 2字节 |                                               |                                           | 46~1500字节             | 4字节 |
| -------- | ------ | ----- | --------------------------------------------- | ----------------------------------------- | ----------------------- | ----- |
| 目标 MAC | 源 MAC | 长度  | 逻辑链路控制LLC<br />（Logical Link Control） | SNAP<br />（Sub-network Access Protocol） | 数据<br />（TCP报文等） | FCS   |

## 数据链路层的细分

IEEE802 将数据链路层分为两个子层：

+ 逻辑链路控制（LLC）层–负责向其上层提供服务

  + 识别不同的网络层协议，然后对它们进行封装与处理（帧中LLC+SNAP部分）

    + > https://baike.baidu.com/item/SAP/3082834

  + 建立 / 释放逻辑连接，差错控制

  + 帧序号处理（帧同步）

  + 流量控制

+ 介质访问控制（MAC）层–屏蔽了不同物理链路种类的差异性。
  + 帧定界和识别
  + 目标站的寻址、源站寻址信息的传送
  + 信息的透明数据传输
  + 错误检查【通过校验码等方式】
  + 对物理传输介质的访问

LAN  对  LLC  子层透明， 只有下到  MAC  子层才可见到所连接的是采用什么标准的局域网（总线网、令牌总线网或令牌环网等）。

## 其他数据链路层协议

+ PPP (Point-to-Point Protocol)

  点对点传输协议，使用电话线，ADSL等线路实现接入。有些 ISP 在以太网上利用 PPPoE (PPP over Ethernet) 协议提供PPP功能，通信线路依靠以太网模拟。

+ 令牌环网

+ ATM

## 家里上网是怎么实现的（数据链路层）

+ 模拟电话线：通过电话线使用PPP，连接到ISP调制解调器上，再连接到路由器
+ ADSL：模拟电话线的拓展，将电话音频信号和数据数字信号分离，互不干扰。
+ FTTH (Fiber To The Home) 使用 ONU 设备将光信号和电子信号转换，通过光缆连接到服务商处，服务商再转换后接入路由器。

# IP 协议簇及其相关技术【网络层】

## IP 协议及其基础知识

IP 协议对应OSI 参考模型的第三层（网络层）。网络层的主要作用是实现**终端节点**之间的通信，即**点对点**通信。

数据链路层的主要作用是在互联同一种数据链路的节点之间进行通信，而网络层可以跨越不同的数据链路。也可以认为：数据链路层提供**直连设备**之间的通信功能（自己注：交换机并没有切割两个设备，或许两个设备可以看成是直连的），网络层的IP则负责在**没有直连**的两个网络之间进行通信传输。

### 路由控制

路由控制是能够控制分组数据发送到最终目标地址的功能。

+ Hop 的概念

  一跳(hop)是指利用数据链路层及以下层的功能**传输数据帧的一个区间**，对于以太网等数据链路中使用 MAC 地址传输数据帧的，一跳是指从源 MAC 地址到目标 MAC 地址之间传输数据帧的区间。

  IP路由（即多跳路由）中，节点转发数据包时，**只指定下一个路由器或主机**，而不是将到最终目标地址为止的所有通路全部指定出来，每个区间（每跳）在转发IP数据包时，会指定下一跳的操作。

+ 路由控制表

  为了将数据包发给目标主机，所有主机都维护着一张路由控制表，记录 IP 数据下一步该发送给哪个路由器，其包括 `目的网段及掩码、下一跳 IP、输出接口、cost 等内容`。

  + 路由控制表有两种生成形式：管理员手动设置（静态路由控制）、路由器与其他路由器交互信息时自动学习（动态路由控制）。
  + 在路由聚合的情况下，如果出现多跳网络地址的记录都符合情况，则使用**最长匹配原则**决定下一跳地址。
  + 默认路由：任意一个地址都能和它匹配 （表示为 0.0.0.0/0 或 default）
  + 主机路由：IP地址/32 被称为主机路由。他不是按照网段进行路由，而是完全基于这个主机设备的 IP 进行路由。例如在该网络中，我需要单独控制其中一台机器的路由选择结果。
  + 环回地址：127.0.0.1 localhost 同一台计算机上程序进行网络通信所使用的地址。
  + 路由控制表的聚合：类似 CIDR 构建超网的方式。例如，路由器发现 192.168.2.0/25, 192.168.2.1/25 的下一跳都是路由器 A，那么干脆记成 192.168.2.0/24 的下一跳是路由器 A，这样就**缩小了路由表**，减轻路由器负担，使查表变快。聚合完成后，还可以将聚合信息发送给临近路由器进行公告。

### 分包与组包

最大传输单位（MTU, Maximum Transmission Unit）每个链路有各自的最大传输单位

每个数据链路的最大传输单位不同，IP对它的上层隐藏了这一细节，抽象了数据链路层。IP进行分片处理，将较大的  IP 包分成多个较小的 IP 包。

由于每条链路的最大传输单元不同，路由器或主机会按照自己的需求对数据报进行分片，分片之后的数据报**只能由目标主机**进行重组。即：路由器虽然会做分片，但是不会重组。这样处理的原因：IP 是不可靠传输，分片可能会在中间丢失，而且即使在中间某处重新组装，再经过下一站时也可能再次被拆分，会给路由器带来多余的负担，降低网络传送效率。

为了尽量减小分片带来的路由器负担，会采用**路径MTU发现**技术。路径MTU指从发送端主机到接收端主机的所有链路中最小的 MTU，主机按此将数据报分片然后再发送出去，避免中途路由器进行分片处理。这个过程是：

+ 发送时 IP 首部中的分片标志位设置为不分片
+ 中途某路由器如果发现数据报过大且不分片就转发不了，就丢包，并通过 ICMP 通知下一次 MTU 大小
+ 反复上述过程，直到路径上再也没有路由器返回 ICMP 消息。
+ UDP 层转发过来的消息“UDP 首部 + UDP 数据”在 IP 层被分片。按分片大小发送。 （UDP 似乎不会感知到，只有一个 UDP 首部）

上述是 UDP 的例子，在 TCP 情况下，**TCP 会将数据分成不会再被 IP 层分片的大小**再传给 IP 层。（TCP 知道这个事，每个数据报都有一个 TCP 首部）

### IP 地址 及 相关知识

IPV4 由 32 位正整数表示，每 8 位为 1 组。其由两部分组成：“网络标识（网络地址）”  + “主机标识（主机地址）”。子网掩码用于标识前多少位为网络标识。

相互连接的每个数据链路段必须具有不同的“网络标识”，每个数据链路段内的主机必须有相同的网络地址。同一网段内的“主机标识”必须不同。当 IP 数据包转发时，利用目标 IP 的网络标识进行路由，即使看不到主机标识，只要看到网络标识就知道在哪个网段。

> 个人理解：家里的路由器其实是类似与单臂路由的路由器+交换机的组合

#### IP 地址分类

IP 地址分为 A B C D 四类。

+ A类地址前 8 位为网路标识，其中首位为 0，因此网段为 0.0.0.0~127.0.0.1
+ B类地址前 16 位为网络标识，且前 2 位必须为 10，因此网段位 128.0.0.1~191.255.0.0
+ C类地址前 32 位位网络标识，且前 3 位必须为 110，因此网段为 192.0.0.0~223.255.255.0
+ D类地址没有主机地址，全是网络标识，且前 4 位必须为 1110。它没有主机地址，所以通常用于多播【直说不了解即可】。

>  需要说明的是，主机地址全为 0 标识网络标识（网络号），或暂时不可获取 IP 地址；全为 1 表示广播地址。因此分配主机地址时应该去掉这两种情况。
>
> 广播地址用来向一个网段发送数据包，其主机位全为 1。广播包分为本地广播（本网段内）和直接广播（发到其他网段，通常会被屏蔽）。

##### 子网划分：

A类B类地址挺浪费的，网络标识相同的主机必须属于同一个链路，那一个链路内放几万台机器是基本不可能的。所以这个地址很浪费啊。
所以有了子网划分：可以通过子网掩码进一步从 ABC类地址划分出更小的网络。即：将主机地址的前面拿出一些，作为子网地址。从有了子网开始，一个 IP 地址的识别，除了 IP 本身，还有一个子网掩码，用于标识内部网。

#### CIDR 和 VLSM

+ CIDR 无类型域间路（无分类编址）由 classless inter-domain routing 
+ VLSM 可变长子网掩码 variable length subnet mask。

CIDR`**完全放弃**了之前的分类IP地址表示法，它真正消除了传统的`A`类、`B`类、`C`类地址以及划分子网的概念，它使用如下的IP地址表示法：`IP地址 ::= {<网络前缀>， <主机号>} / 网络前缀所占位数`

CIDR 能够将多个连续的网络合并到一个大的网络内，**通过路由集中降低了路由器的负担**。例如 203.183.224.0/23 + 203.183.254.0/23 = 203.183.224.0/22。这种通过使用网络前缀减少路由表项的方式成为路由聚合，也称为**超网**。

#### 全局地址和私有地址

私网最初设计被计划为不连接互联网，所以每一个私网的 IP 都可以自行指定，不同私网出现相同的 IP 并没关系。不过万一因为改变配置联网了，那就出现问题了，所以为了防止误用和冲突，制定了私有IP。

+ A类：10.0.0.1~10.255.255.255 (10/8) 
+ B类：172.16.0.1~172.31.255.255 (172.16/12) 【B类有 16 个私网网段诶】
+ C类：192.168.0.0~192.168.255.255 (192.168/16)

不过后来，NAT (network address translation 网络地址转换)技术诞生之后，给路由器一个公网 IP，那么路由器内部的私网 IP 可以通过 NAT 进行互联网通信。这也恰好缓解了 IP 不足的问题。

## IP 协议的相关技术（IP 协议簇的其他东西）

# TCP与UDP【传输层】

# 路由协议

# 应用协议

# 网络安全



